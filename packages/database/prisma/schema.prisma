generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  PATIENT
  VERIFIED_DOCTOR
  NURSE
  MEDICAL_STUDENT
  PHARMACIST
  COMMUNITY_CONTRIBUTOR
  MODERATOR
  ADMIN
}

enum PostType {
  TEXT
  IMAGE
  VIDEO
  LINK
  POLL
  GALLERY
  LIVE
}

enum SortType {
  HOT
  NEW
  TOP
  RISING
  CONTROVERSIAL
  BEST
}

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  username          String    @unique
  passwordHash      String
  role              UserRole  @default(PATIENT)
  verified          Boolean   @default(false)
  specialty         String?
  bio               String?
  avatar            String?
  banner            String?
  postKarma         Int       @default(0)
  commentKarma      Int       @default(0)
  totalKarma        Int       @default(0)
  isPremium         Boolean   @default(false)
  isNSFW            Boolean   @default(false)
  isSuspended       Boolean   @default(false)
  isShadowBanned    Boolean   @default(false)
  emailVerified     Boolean   @default(false)
  twoFactorEnabled  Boolean   @default(false)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  posts             Post[]
  comments          Comment[]
  votes             Vote[]
  savedPosts        SavedPost[]
  savedComments     SavedComment[]
  hiddenPosts       HiddenPost[]
  awards            Award[]
  givenAwards       AwardGiven[]
  communities       CommunityMember[]
  moderating        CommunityModerator[]
  following         Follow[]              @relation("Following")
  followers         Follow[]              @relation("Followers")
  blockedUsers      Block[]               @relation("Blocker")
  blockedBy         Block[]               @relation("Blocked")
  messages          Message[]             @relation("Sender")
  receivedMessages  Message[]             @relation("Receiver")
  notifications     Notification[]
  reports           Report[]
  
  @@index([email])
  @@index([username])
  @@index([totalKarma])
}

model Community {
  id                String              @id @default(cuid())
  name              String              @unique
  displayName       String
  description       String?
  icon              String?
  banner            String?
  theme             Json?
  rules             Json?
  isNSFW            Boolean             @default(false)
  isPrivate         Boolean             @default(false)
  isRestricted      Boolean             @default(false)
  memberCount       Int                 @default(0)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  posts             Post[]
  members           CommunityMember[]
  moderators        CommunityModerator[]
  flairs            Flair[]
  
  @@index([name])
  @@index([memberCount])
}

model Post {
  id                String        @id @default(cuid())
  type              PostType      @default(TEXT)
  title             String
  content           String?
  url               String?
  mediaUrls         String[]
  thumbnailUrl      String?
  authorId          String
  author            User          @relation(fields: [authorId], references: [id])
  communityId       String
  community         Community     @relation(fields: [communityId], references: [id])
  flairId           String?
  flair             Flair?        @relation(fields: [flairId], references: [id])
  upvotes           Int           @default(0)
  downvotes         Int           @default(0)
  score             Int           @default(0)
  commentCount      Int           @default(0)
  isNSFW            Boolean       @default(false)
  isSpoiler         Boolean       @default(false)
  isPinned          Boolean       @default(false)
  isLocked          Boolean       @default(false)
  isArchived        Boolean       @default(false)
  isRemoved         Boolean       @default(false)
  commentsDisabled  Boolean       @default(false)
  contestMode       Boolean       @default(false)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  editedAt          DateTime?
  
  comments          Comment[]
  votes             Vote[]
  savedBy           SavedPost[]
  hiddenBy          HiddenPost[]
  awards            AwardGiven[]
  reports           Report[]
  
  @@index([authorId])
  @@index([communityId])
  @@index([score])
  @@index([createdAt])
}

model Comment {
  id              String      @id @default(cuid())
  content         String
  authorId        String
  author          User        @relation(fields: [authorId], references: [id])
  postId          String
  post            Post        @relation(fields: [postId], references: [id], onDelete: Cascade)
  parentId        String?
  parent          Comment?    @relation("CommentReplies", fields: [parentId], references: [id])
  replies         Comment[]   @relation("CommentReplies")
  upvotes         Int         @default(0)
  downvotes       Int         @default(0)
  score           Int         @default(0)
  depth           Int         @default(0)
  isStickied      Boolean     @default(false)
  isDistinguished Boolean     @default(false)
  isRemoved       Boolean     @default(false)
  isLocked        Boolean     @default(false)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  editedAt        DateTime?
  
  votes           Vote[]
  savedBy         SavedComment[]
  awards          AwardGiven[]
  reports         Report[]
  
  @@index([postId])
  @@index([authorId])
  @@index([parentId])
  @@index([score])
}

model Vote {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  postId      String?
  post        Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  commentId   String?
  comment     Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)
  value       Int      // 1 for upvote, -1 for downvote
  createdAt   DateTime @default(now())
  
  @@unique([userId, postId])
  @@unique([userId, commentId])
  @@index([userId])
  @@index([postId])
  @@index([commentId])
}

model Flair {
  id          String    @id @default(cuid())
  text        String
  color       String?
  communityId String
  community   Community @relation(fields: [communityId], references: [id])
  isUserFlair Boolean   @default(false)
  
  posts       Post[]
  
  @@index([communityId])
}

model Award {
  id          String       @id @default(cuid())
  name        String
  description String?
  icon        String
  cost        Int
  tier        Int          @default(1)
  
  userId      String
  user        User         @relation(fields: [userId], references: [id])
  given       AwardGiven[]
  
  @@index([userId])
}

model AwardGiven {
  id        String   @id @default(cuid())
  awardId   String
  award     Award    @relation(fields: [awardId], references: [id])
  giverId   String
  giver     User     @relation(fields: [giverId], references: [id])
  postId    String?
  post      Post?    @relation(fields: [postId], references: [id])
  commentId String?
  comment   Comment? @relation(fields: [commentId], references: [id])
  createdAt DateTime @default(now())
  
  @@index([postId])
  @@index([commentId])
  @@index([giverId])
}

model SavedPost {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  
  @@unique([userId, postId])
  @@index([userId])
}

model SavedComment {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  commentId String
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  
  @@unique([userId, commentId])
  @@index([userId])
}

model HiddenPost {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  
  @@unique([userId, postId])
  @@index([userId])
}

model CommunityMember {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  communityId String
  community   Community @relation(fields: [communityId], references: [id])
  joinedAt    DateTime  @default(now())
  
  @@unique([userId, communityId])
  @@index([userId])
  @@index([communityId])
}

model CommunityModerator {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  communityId String
  community   Community @relation(fields: [communityId], references: [id])
  permissions Json
  addedAt     DateTime  @default(now())
  
  @@unique([userId, communityId])
  @@index([communityId])
}

model Follow {
  id          String   @id @default(cuid())
  followerId  String
  follower    User     @relation("Following", fields: [followerId], references: [id])
  followingId String
  following   User     @relation("Followers", fields: [followingId], references: [id])
  createdAt   DateTime @default(now())
  
  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model Block {
  id        String   @id @default(cuid())
  blockerId String
  blocker   User     @relation("Blocker", fields: [blockerId], references: [id])
  blockedId String
  blocked   User     @relation("Blocked", fields: [blockedId], references: [id])
  createdAt DateTime @default(now())
  
  @@unique([blockerId, blockedId])
  @@index([blockerId])
}

model Message {
  id         String   @id @default(cuid())
  senderId   String
  sender     User     @relation("Sender", fields: [senderId], references: [id])
  receiverId String
  receiver   User     @relation("Receiver", fields: [receiverId], references: [id])
  subject    String?
  content    String
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
  
  @@index([senderId])
  @@index([receiverId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  type      String
  content   String
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([isRead])
}

model Report {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  postId    String?
  post      Post?    @relation(fields: [postId], references: [id])
  commentId String?
  comment   Comment? @relation(fields: [commentId], references: [id])
  reason    String
  details   String?
  status    String   @default("PENDING")
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([status])
}
